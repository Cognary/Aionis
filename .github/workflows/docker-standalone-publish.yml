name: Docker Standalone Publish

on:
  push:
    tags:
      - "standalone-v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Standalone image tag (standalone-vX.Y.Z)"
        required: false
        type: string
      image_repo:
        description: "GHCR image repo (default: ghcr.io/<owner>/aionis)"
        required: false
        type: string
      platforms:
        description: "Build platforms CSV"
        required: false
        default: "linux/amd64,linux/arm64"
        type: string
      publish_latest:
        description: "Also publish standalone-latest tag"
        required: false
        default: true
        type: boolean
      dry_run:
        description: "If true, build only (no push)"
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Resolve publish inputs
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            version="${GITHUB_REF_NAME}"
            dry_run=false
            publish_latest=true
          else
            version="${{ github.event.inputs.tag }}"
            if [[ -z "${version}" ]]; then
              version="standalone-v0.0.0-${GITHUB_SHA::12}"
            fi
            dry_run="${{ github.event.inputs.dry_run }}"
            publish_latest="${{ github.event.inputs.publish_latest }}"
          fi

          if [[ "${version}" =~ ^v[0-9] ]]; then
            version="standalone-${version}"
          fi
          if [[ "${version}" =~ ^standalone-[0-9] ]]; then
            version="standalone-v${version#standalone-}"
          fi
          if [[ ! "${version}" =~ ^standalone-v[0-9] ]]; then
            echo "invalid standalone tag: ${version}. expected standalone-vX.Y.Z" >&2
            exit 1
          fi

          image_repo="${{ github.event.inputs.image_repo }}"
          if [[ -z "${image_repo}" ]]; then
            owner_lc="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
            image_repo="ghcr.io/${owner_lc}/aionis"
          fi

          echo "IMAGE_REPO=${image_repo}" >> "$GITHUB_ENV"
          echo "IMAGE_TAG=${version}" >> "$GITHUB_ENV"
          echo "PLATFORMS=${{ github.event.inputs.platforms || 'linux/amd64,linux/arm64' }}" >> "$GITHUB_ENV"
          echo "DRY_RUN=${dry_run}" >> "$GITHUB_ENV"
          echo "PUBLISH_LATEST=${publish_latest}" >> "$GITHUB_ENV"
          tags="${image_repo}:${version}"
          if [[ "${publish_latest}" == "true" ]]; then
            tags="${tags}"$'\n'"${image_repo}:standalone-latest"
          fi
          {
            echo "TAGS<<EOF"
            echo "${tags}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Resolve GHCR credentials
        if: env.DRY_RUN != 'true'
        shell: bash
        env:
          GHCR_USERNAME_SECRET: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN_SECRET: ${{ secrets.GHCR_TOKEN }}
          GITHUB_TOKEN_SECRET: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          username="${GHCR_USERNAME_SECRET:-}"
          password="${GHCR_TOKEN_SECRET:-}"
          source_name="ghcr_secret"
          if [[ -z "${username}" || -z "${password}" ]]; then
            username="${GITHUB_ACTOR}"
            password="${GITHUB_TOKEN_SECRET}"
            source_name="github_token"
          fi
          if [[ -z "${username}" || -z "${password}" ]]; then
            echo "missing GHCR credentials (set repo/org secrets GHCR_USERNAME + GHCR_TOKEN or ensure GITHUB_TOKEN is available)." >&2
            exit 1
          fi
          echo "GHCR_USERNAME=${username}" >> "$GITHUB_ENV"
          echo "GHCR_PASSWORD=${password}" >> "$GITHUB_ENV"
          echo "GHCR_CREDENTIAL_SOURCE=${source_name}" >> "$GITHUB_ENV"

      - name: Login to GHCR
        if: env.DRY_RUN != 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USERNAME }}
          password: ${{ env.GHCR_PASSWORD }}

      - name: Build (dry-run)
        if: env.DRY_RUN == 'true'
        shell: bash
        run: |
          set -euo pipefail
          dry_platform="${PLATFORMS%%,*}"
          docker buildx build \
            --file Dockerfile.standalone \
            --platform "${dry_platform}" \
            -t "${IMAGE_REPO}:${IMAGE_TAG}" \
            --load \
            .

      - name: Build and push
        if: env.DRY_RUN != 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.standalone
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ env.TAGS }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
