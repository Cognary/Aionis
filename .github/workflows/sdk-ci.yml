name: SDK CI

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "packages/sdk/**"
      - "src/sdk/**"
      - "src/dev/sdk-*.ts"
      - "examples/rules_evaluate.sh"
      - "examples/tools_select.sh"
      - "scripts/sdk-release-check.sh"
      - "scripts/sdk-python-release-check.sh"
      - "scripts/docs-check.sh"
      - "scripts/ci/capability-api-probes.sh"
      - "scripts/ci/policy-planner-api-probes.sh"
      - "scripts/ci/*.mjs"
      - "docs/README.md"
      - "docs/SDK*.md"
      - ".github/workflows/sdk-ci.yml"
      - "package.json"
      - "package-lock.json"
      - "packages/python-sdk/**"
      - "src/dev/python-sdk-smoke.py"
  push:
    branches: ["main"]
    paths:
      - "packages/sdk/**"
      - "src/sdk/**"
      - "src/dev/sdk-*.ts"
      - "examples/rules_evaluate.sh"
      - "examples/tools_select.sh"
      - "scripts/sdk-release-check.sh"
      - "scripts/sdk-python-release-check.sh"
      - "scripts/docs-check.sh"
      - "scripts/ci/capability-api-probes.sh"
      - "scripts/ci/policy-planner-api-probes.sh"
      - "scripts/ci/*.mjs"
      - "docs/README.md"
      - "docs/SDK*.md"
      - ".github/workflows/sdk-ci.yml"
      - "package.json"
      - "package-lock.json"
      - "packages/python-sdk/**"
      - "src/dev/python-sdk-smoke.py"

jobs:
  sdk-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: npm ci

      - name: Lint
        run: npm run -s lint

      - name: CI probe unit tests
        run: npm run -s test:ci-probes

      - name: Root build
        run: npm run -s build

      - name: SDK build
        run: npm run -s sdk:build

      - name: SDK release checks
        run: npm run -s sdk:release-check

      - name: Python SDK compile
        run: npm run -s sdk:py:compile

      - name: Python SDK release checks
        run: npm run -s sdk:py:release-check

      - name: SDK package dry-run
        run: npm run -s sdk:pack-dry-run

      - name: Docs check
        run: npm run -s docs:check

  sdk-capability-negotiation-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    strategy:
      fail-fast: false
      matrix:
        include:
          - profile: postgres
            backend: postgres
            embedded_experimental_enabled: "false"
            embedded_snapshot_max_bytes: "52428800"
            shadow_dual_write_enabled: "false"
            embedded_session_graph_enabled: "true"
            embedded_pack_export_enabled: "true"
            embedded_pack_import_enabled: "true"
          - profile: embedded_capability_off
            backend: embedded
            embedded_experimental_enabled: "true"
            embedded_snapshot_max_bytes: "12000"
            shadow_dual_write_enabled: "true"
            embedded_session_graph_enabled: "false"
            embedded_pack_export_enabled: "false"
            embedded_pack_import_enabled: "false"
          - profile: embedded_feature_enabled
            backend: embedded
            embedded_experimental_enabled: "true"
            embedded_snapshot_max_bytes: "12000"
            shadow_dual_write_enabled: "true"
            embedded_session_graph_enabled: "true"
            embedded_pack_export_enabled: "true"
            embedded_pack_import_enabled: "true"
    env:
      DATABASE_URL: postgres://aionis:aionis@127.0.0.1:5432/aionis_memory
      PORT: "3101"
      ADMIN_TOKEN: ci-admin-token
      MEMORY_STORE_BACKEND: ${{ matrix.backend }}
      MEMORY_STORE_EMBEDDED_EXPERIMENTAL_ENABLED: ${{ matrix.embedded_experimental_enabled }}
      MEMORY_STORE_EMBEDDED_SNAPSHOT_MAX_BYTES: ${{ matrix.embedded_snapshot_max_bytes }}
      MEMORY_STORE_EMBEDDED_SNAPSHOT_COMPACTION_ENABLED: "true"
      MEMORY_STORE_EMBEDDED_SNAPSHOT_COMPACTION_MAX_ROUNDS: "8"
      MEMORY_STORE_EMBEDDED_SHADOW_MIRROR_ENABLED: "false"
      MEMORY_SHADOW_DUAL_WRITE_ENABLED: ${{ matrix.shadow_dual_write_enabled }}
      MEMORY_SHADOW_DUAL_WRITE_STRICT: "false"
      MEMORY_STORE_EMBEDDED_RECALL_DEBUG_EMBEDDINGS_ENABLED: "false"
      MEMORY_STORE_EMBEDDED_RECALL_AUDIT_ENABLED: "true"
      MEMORY_STORE_EMBEDDED_SESSION_GRAPH_ENABLED: ${{ matrix.embedded_session_graph_enabled }}
      MEMORY_STORE_EMBEDDED_PACK_EXPORT_ENABLED: ${{ matrix.embedded_pack_export_enabled }}
      MEMORY_STORE_EMBEDDED_PACK_IMPORT_ENABLED: ${{ matrix.embedded_pack_import_enabled }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: npm ci

      - name: Prepare env file
        run: |
          cp .env.example .env
          {
            echo "DATABASE_URL=${DATABASE_URL}"
            echo "PORT=${PORT}"
            echo "ADMIN_TOKEN=${ADMIN_TOKEN}"
            echo "MEMORY_STORE_BACKEND=${MEMORY_STORE_BACKEND}"
            echo "MEMORY_STORE_EMBEDDED_EXPERIMENTAL_ENABLED=${MEMORY_STORE_EMBEDDED_EXPERIMENTAL_ENABLED}"
            echo "MEMORY_STORE_EMBEDDED_SNAPSHOT_MAX_BYTES=${MEMORY_STORE_EMBEDDED_SNAPSHOT_MAX_BYTES}"
            echo "MEMORY_STORE_EMBEDDED_SNAPSHOT_COMPACTION_ENABLED=${MEMORY_STORE_EMBEDDED_SNAPSHOT_COMPACTION_ENABLED}"
            echo "MEMORY_STORE_EMBEDDED_SNAPSHOT_COMPACTION_MAX_ROUNDS=${MEMORY_STORE_EMBEDDED_SNAPSHOT_COMPACTION_MAX_ROUNDS}"
            echo "MEMORY_STORE_EMBEDDED_SHADOW_MIRROR_ENABLED=${MEMORY_STORE_EMBEDDED_SHADOW_MIRROR_ENABLED}"
            echo "MEMORY_SHADOW_DUAL_WRITE_ENABLED=${MEMORY_SHADOW_DUAL_WRITE_ENABLED}"
            echo "MEMORY_SHADOW_DUAL_WRITE_STRICT=${MEMORY_SHADOW_DUAL_WRITE_STRICT}"
            echo "MEMORY_STORE_EMBEDDED_RECALL_DEBUG_EMBEDDINGS_ENABLED=${MEMORY_STORE_EMBEDDED_RECALL_DEBUG_EMBEDDINGS_ENABLED}"
            echo "MEMORY_STORE_EMBEDDED_RECALL_AUDIT_ENABLED=${MEMORY_STORE_EMBEDDED_RECALL_AUDIT_ENABLED}"
            echo "MEMORY_STORE_EMBEDDED_SESSION_GRAPH_ENABLED=${MEMORY_STORE_EMBEDDED_SESSION_GRAPH_ENABLED}"
            echo "MEMORY_STORE_EMBEDDED_PACK_EXPORT_ENABLED=${MEMORY_STORE_EMBEDDED_PACK_EXPORT_ENABLED}"
            echo "MEMORY_STORE_EMBEDDED_PACK_IMPORT_ENABLED=${MEMORY_STORE_EMBEDDED_PACK_IMPORT_ENABLED}"
          } >> .env

      - name: Start db
        run: docker compose up -d db

      - name: Wait for db
        run: |
          for i in {1..60}; do
            if docker compose exec -T db pg_isready -U aionis -d aionis_memory >/dev/null 2>&1; then
              exit 0
            fi
            sleep 2
          done
          echo "db not ready in time" >&2
          exit 1

      - name: Run migrations
        run: docker compose run --rm migrate

      - name: Build API
        run: npm run -s build

      - name: Shadow dual-write strict fail-fast guard (embedded)
        if: matrix.backend == 'embedded'
        run: |
          set +e
          timeout 15s env \
            MEMORY_SHADOW_DUAL_WRITE_ENABLED=true \
            MEMORY_SHADOW_DUAL_WRITE_STRICT=true \
            MEMORY_STORE_EMBEDDED_SHADOW_MIRROR_ENABLED=false \
            node dist/index.js >/tmp/sdk_ci_shadow_strict_guard.log 2>&1
          rc=$?
          set -e

          if [[ "${rc}" -eq 0 ]]; then
            echo "strict guard probe unexpectedly succeeded" >&2
            sed -n '1,220p' /tmp/sdk_ci_shadow_strict_guard.log >&2 || true
            exit 1
          fi

          if [[ "${rc}" -eq 124 ]]; then
            echo "strict guard probe timed out; expected immediate fail-fast" >&2
            sed -n '1,220p' /tmp/sdk_ci_shadow_strict_guard.log >&2 || true
            exit 1
          fi

          grep -q "MEMORY_SHADOW_DUAL_WRITE_STRICT=true requires MEMORY_STORE_EMBEDDED_SHADOW_MIRROR_ENABLED=true when MEMORY_STORE_BACKEND=embedded" \
            /tmp/sdk_ci_shadow_strict_guard.log || {
              echo "strict guard probe missing expected validation error" >&2
              sed -n '1,220p' /tmp/sdk_ci_shadow_strict_guard.log >&2 || true
              exit 1
            }

      - name: Shadow dual-write strict runtime hard-fail (embedded)
        if: matrix.backend == 'embedded'
        run: |
          set -euo pipefail

          API_PID=""
          cleanup() {
            if [[ -n "${API_PID}" ]]; then
              kill "${API_PID}" >/dev/null 2>&1 || true
              wait "${API_PID}" >/dev/null 2>&1 || true
            fi
            docker compose exec -T db psql -U aionis -d aionis_memory -c \
              "DO \$\$ BEGIN IF to_regclass('public.memory_commits_v2_ci_tmp') IS NOT NULL THEN EXECUTE 'ALTER TABLE memory_commits_v2_ci_tmp RENAME TO memory_commits_v2'; END IF; END \$\$;" \
              >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          table_exists="$(docker compose exec -T db psql -U aionis -d aionis_memory -Atc "SELECT to_regclass('public.memory_commits_v2') IS NOT NULL;")"
          if [[ "${table_exists}" != "t" ]]; then
            echo "memory_commits_v2 table missing before strict runtime probe" >&2
            exit 1
          fi

          docker compose exec -T db psql -U aionis -d aionis_memory -c \
            "ALTER TABLE memory_commits_v2 RENAME TO memory_commits_v2_ci_tmp;"

          env \
            MEMORY_SHADOW_DUAL_WRITE_ENABLED=true \
            MEMORY_SHADOW_DUAL_WRITE_STRICT=true \
            MEMORY_STORE_EMBEDDED_SHADOW_MIRROR_ENABLED=true \
            node dist/index.js >/tmp/sdk_ci_shadow_strict_runtime.log 2>&1 &
          API_PID=$!

          for i in {1..60}; do
            if curl -fsS "http://127.0.0.1:${PORT}/health" >/tmp/sdk_ci_shadow_strict_runtime_health.json 2>/dev/null; then
              break
            fi
            sleep 1
          done

          if [[ ! -s /tmp/sdk_ci_shadow_strict_runtime_health.json ]]; then
            echo "strict runtime probe API never became ready" >&2
            sed -n '1,220p' /tmp/sdk_ci_shadow_strict_runtime.log >&2 || true
            exit 1
          fi

          curl -sS -o /tmp/sdk_ci_shadow_strict_runtime_write.json -w "%{http_code}" \
            -X POST "http://127.0.0.1:${PORT}/v1/memory/write" \
            -H "content-type: application/json" \
            --data-binary @- >/tmp/sdk_ci_shadow_strict_runtime_status.txt <<'JSON'
          {
            "scope": "default",
            "actor": "ci",
            "input_text": "sdk-ci strict runtime mirror failure probe",
            "auto_embed": false,
            "nodes": [
              {
                "client_id": "sdk_ci_shadow_strict_runtime_probe",
                "type": "event",
                "text_summary": "strict runtime mirror failure probe"
              }
            ],
            "edges": []
          }
          JSON

          node -e '
            const fs = require("fs");
            const status = Number(fs.readFileSync("/tmp/sdk_ci_shadow_strict_runtime_status.txt", "utf8").trim());
            const body = JSON.parse(fs.readFileSync("/tmp/sdk_ci_shadow_strict_runtime_write.json", "utf8"));
            if (status !== 500) {
              throw new Error(`strict runtime probe expected 500, got ${status}`);
            }
            if (body.error !== "shadow_dual_write_strict_failure") {
              throw new Error(`strict runtime probe expected error=shadow_dual_write_strict_failure, got ${String(body.error)}`);
            }
            if (!body.details || body.details.capability !== "shadow_mirror_v2") {
              throw new Error("strict runtime probe expected details.capability=shadow_mirror_v2");
            }
            if (body.details.degraded_mode !== "mirror_failed") {
              throw new Error(`strict runtime probe expected details.degraded_mode=mirror_failed, got ${String(body.details.degraded_mode)}`);
            }
            if (body.details.failure_mode !== "soft_degrade") {
              throw new Error(`strict runtime probe expected details.failure_mode=soft_degrade, got ${String(body.details.failure_mode)}`);
            }
            if (body.details.fallback_applied !== false || body.details.strict !== true) {
              throw new Error("strict runtime probe expected fallback_applied=false and strict=true");
            }
          '

      - name: SDK capability negotiation smoke
        run: |
          node dist/index.js >/tmp/sdk_ci_api.log 2>&1 &
          API_PID=$!

          for i in {1..60}; do
            if curl -fsS "http://127.0.0.1:${PORT}/health" >/tmp/sdk_ci_health.json 2>/dev/null; then
              break
            fi
            sleep 1
          done

          if [[ ! -s /tmp/sdk_ci_health.json ]]; then
            echo "health endpoint never became ready" >&2
            sed -n '1,220p' /tmp/sdk_ci_api.log >&2 || true
            exit 1
          fi

          npm run -s sdk:smoke >/tmp/sdk_ci_smoke_ts.json
          npm run -s sdk:py:smoke >/tmp/sdk_ci_smoke_py.json

          node -e '
            const fs = require("fs");
            const tsOut = JSON.parse(fs.readFileSync("/tmp/sdk_ci_smoke_ts.json", "utf8"));
            const pyOut = JSON.parse(fs.readFileSync("/tmp/sdk_ci_smoke_py.json", "utf8"));
            const ensure = (cond, msg) => { if (!cond) throw new Error(msg); };
            for (const [name, out] of [["ts", tsOut], ["py", pyOut]]) {
              ensure(out && out.ok === true, `${name} smoke must be ok=true`);
              ensure(
                out.calls && out.calls.health && out.calls.pack_export && out.calls.sessions_graph && out.calls.pack_import,
                `${name} smoke must include health + pack_export + sessions_graph + pack_import`,
              );
            }

            const tsBackend = tsOut.calls.health.backend;
            const pyBackend = pyOut.calls.health.backend;
            ensure(typeof tsBackend === "string" && tsBackend.length > 0, "ts smoke must include health.backend");
            ensure(typeof pyBackend === "string" && pyBackend.length > 0, "py smoke must include health.backend");
            ensure(tsBackend === pyBackend, `ts/py backend mismatch: ${String(tsBackend)} vs ${String(pyBackend)}`);

            function assertClientByCapabilities(name, out) {
              const recallCaps = out.calls.health.recall_capabilities || {};
              const writeCaps = out.calls.health.write_capabilities || {};
              const caps = out.calls.health.feature_capabilities || {};
              for (const key of ["debug_embeddings", "audit_insert"]) {
                ensure(typeof recallCaps[key] === "boolean", `${name} recall_capabilities.${key} must be boolean`);
              }
              ensure(
                typeof writeCaps.shadow_mirror_v2 === "boolean",
                `${name} write_capabilities.shadow_mirror_v2 must be boolean`,
              );
              for (const key of ["packs_export", "sessions_graph", "packs_import"]) {
                ensure(typeof caps[key] === "boolean", `${name} feature_capabilities.${key} must be boolean`);
              }

              if (caps.packs_export === true) {
                ensure(
                  typeof out.calls.pack_export.manifest_sha256 === "string" && out.calls.pack_export.manifest_sha256.length > 0,
                  `${name} capability-on packs_export must include manifest sha256`,
                );
              } else {
                const cap = out.calls.pack_export.capability_error;
                ensure(cap && cap.capability === "packs_export", `${name} capability-off packs_export must expose capability error`);
              }

              if (caps.sessions_graph === true) {
                ensure(out.calls.sessions_graph.events_returned >= 1, `${name} capability-on sessions_graph must return events`);
              } else {
                const cap = out.calls.sessions_graph.capability_error;
                ensure(cap && cap.capability === "sessions_graph", `${name} capability-off sessions_graph must expose capability error`);
              }

              if (caps.packs_import === true) {
                ensure(out.calls.pack_import.verified === true, `${name} capability-on packs_import verify_only must be verified`);
                ensure(out.calls.pack_import.imported === false, `${name} capability-on packs_import verify_only must not import`);
              } else {
                const cap = out.calls.pack_import.capability_error;
                ensure(cap && cap.capability === "packs_import", `${name} capability-off packs_import must expose capability error`);
              }
            }

            assertClientByCapabilities("ts", tsOut);
            assertClientByCapabilities("py", pyOut);
            ensure(
              tsOut.calls.health.write_capabilities.shadow_mirror_v2 === pyOut.calls.health.write_capabilities.shadow_mirror_v2,
              "ts/py write capability mismatch: shadow_mirror_v2",
            );
          '

          AIONIS_BASE_URL="http://127.0.0.1:${PORT}" \
          CAPABILITY_PROBE_SCOPE="default" \
          CAPABILITY_PROBE_TENANT_ID="default" \
          CAPABILITY_PROBE_INCLUDE_SHADOW_SOFT_DEGRADE="auto" \
          bash scripts/ci/capability-api-probes.sh >/tmp/sdk_ci_capability_api_probe.json

          AIONIS_BASE_URL="http://127.0.0.1:${PORT}" \
          POLICY_PLANNER_PROBE_SCOPE="default" \
          POLICY_PLANNER_PROBE_TENANT_ID="default" \
          bash scripts/ci/policy-planner-api-probes.sh >/tmp/sdk_ci_policy_planner_probe.json

          kill "${API_PID}" || true
          wait "${API_PID}" || true

      - name: Diagnostics on failure
        if: failure()
        run: |
          docker compose ps || true
          docker compose logs --no-color db || true
          sed -n '1,220p' /tmp/sdk_ci_shadow_strict_guard.log || true
          sed -n '1,220p' /tmp/sdk_ci_shadow_strict_runtime.log || true
          cat /tmp/sdk_ci_shadow_strict_runtime_status.txt || true
          cat /tmp/sdk_ci_shadow_strict_runtime_write.json || true
          sed -n '1,220p' /tmp/sdk_ci_api.log || true
          cat /tmp/sdk_ci_smoke_ts.json || true
          cat /tmp/sdk_ci_smoke_py.json || true
          cat /tmp/sdk_ci_capability_api_probe.json || true
          cat /tmp/sdk_ci_policy_planner_probe.json || true

      - name: Cleanup
        if: always()
        run: docker compose down -v
