name: LongMemEval Gate

on:
  workflow_dispatch:
    inputs:
      gate_limit:
        description: "Rows per offset slice"
        required: false
        default: "8"
        type: string
      gate_offsets:
        description: "Offset CSV (e.g. 0,180)"
        required: false
        default: "0,180"
        type: string
      upload_artifacts:
        description: "Upload gate artifacts"
        required: false
        default: true
        type: boolean
      artifact_retention_days:
        description: "Artifact retention days"
        required: false
        default: "14"
        type: string
  schedule:
    - cron: "0 5 * * 2"
  push:
    branches: ["main"]
    paths:
      - "src/config.ts"
      - "src/index.ts"
      - "src/memory/**"
      - "src/mcp/**"
      - "scripts/bench/**"
      - ".github/workflows/longmemeval-gate.yml"
      - "docker-compose.yml"
      - "package.json"

permissions:
  contents: read

concurrency:
  group: longmemeval-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  longmemeval-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
      MINIMAX_GROUP_ID: ${{ secrets.MINIMAX_GROUP_ID }}
      LONGMEMEVAL_GATE_LIMIT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.gate_limit || '8' }}
      LONGMEMEVAL_GATE_OFFSETS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.gate_offsets || '0,180' }}
      LONGMEMEVAL_GATE_MODEL: MiniMax-M2.1
      LONGMEMEVAL_GATE_ENDPOINT: https://api.minimax.chat/v1/text/chatcompletion_v2
      AIONIS_BASE_URL: http://localhost:3001
      PORT: "3001"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          set -euo pipefail
          if [[ -z "${MINIMAX_API_KEY}" ]]; then
            echo "Missing required secret: MINIMAX_API_KEY" >&2
            exit 1
          fi
          if [[ -z "${MINIMAX_GROUP_ID}" ]]; then
            echo "Missing required secret: MINIMAX_GROUP_ID" >&2
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: npm ci

      - name: Prepare env for minimax embeddings
        shell: bash
        run: |
          set -euo pipefail
          npm run -s env:throughput:benchmark
          {
            echo "APP_ENV=ci"
            echo "PORT=3001"
            echo "MEMORY_AUTH_MODE=off"
            echo "EMBEDDING_PROVIDER=minimax"
            echo "MINIMAX_API_KEY=${MINIMAX_API_KEY}"
            echo "MINIMAX_GROUP_ID=${MINIMAX_GROUP_ID}"
            echo "MINIMAX_EMBED_MODEL=embo-01"
            echo "MINIMAX_EMBED_ENDPOINT=https://api.minimax.chat/v1/embeddings"
            echo "MEMORY_RECALL_PROFILE=strict_edges"
          } >> .env

      - name: Start stack
        run: docker compose up -d --build

      - name: Wait API health
        shell: bash
        run: |
          set -euo pipefail
          ok=0
          for _ in {1..120}; do
            if curl -fsS "http://localhost:3001/health" >/dev/null 2>&1; then
              ok=1
              break
            fi
            sleep 1
          done
          if [[ "${ok}" -ne 1 ]]; then
            echo "API not healthy on localhost:3001" >&2
            exit 1
          fi

      - name: Run LongMemEval gate
        env:
          MINIMAX_CHAT_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
          MINIMAX_CHAT_MODEL: MiniMax-M2.1
          MINIMAX_CHAT_ENDPOINT: https://api.minimax.chat/v1/text/chatcompletion_v2
          MINIMAX_GROUP_ID: ${{ secrets.MINIMAX_GROUP_ID }}
        run: npm run -s bench:longmemeval:gate

      - name: Publish gate summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          summary_file="$(find artifacts/longmemeval/ci_gate -type f -name gate_summary.json | sort | tail -n 1 || true)"
          {
            echo "## LongMemEval Gate"
            echo
            if [[ -n "${summary_file}" && -f "${summary_file}" ]]; then
              echo "summary: \`${summary_file}\`"
              echo
              jq '.' "${summary_file}"
            else
              echo "summary not found"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload gate artifacts
        if: ${{ always() && (github.event_name != 'workflow_dispatch' || inputs.upload_artifacts) }}
        uses: actions/upload-artifact@v4
        with:
          name: longmemeval-gate-artifacts
          path: artifacts/longmemeval/ci_gate/
          retention-days: ${{ fromJSON(github.event_name == 'workflow_dispatch' && github.event.inputs.artifact_retention_days || '14') }}
          if-no-files-found: warn

      - name: Stop stack
        if: always()
        shell: bash
        run: |
          set +e
          if [[ -f docker-compose.yml ]]; then
            docker compose down -v
          else
            echo "docker-compose.yml not found, skip compose down"
          fi
